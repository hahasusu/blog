import{_ as s,c as a,o as n,a4 as l}from"./chunks/framework.GYzjcnJh.js";const m=JSON.parse('{"title":"主从复制","description":"","frontmatter":{"date":"2024-03-01 09:25:32"},"headers":[],"relativePath":"db/mysql/master-slave.md","filePath":"backend/db/mysql/master-slave.md"}'),p={name:"db/mysql/master-slave.md"},e=l(`<h1 id="主从复制" tabindex="-1">主从复制 <a class="header-anchor" href="#主从复制" aria-label="Permalink to &quot;主从复制&quot;">​</a></h1><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#90A4AE;font-style:italic;"># 查看线程</span></span>
<span class="line"><span style="color:#E2931D;">mysql</span><span style="color:#39ADB5;"> &gt;</span><span style="color:#91B859;"> show</span><span style="color:#91B859;"> processlist</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 查看状态</span></span>
<span class="line"><span style="color:#E2931D;">mysql</span><span style="color:#39ADB5;"> &gt;</span><span style="color:#91B859;"> show</span><span style="color:#91B859;"> slave</span><span style="color:#91B859;"> status</span><span style="color:#90A4AE;">\\G</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 从节点开启IO 和 SQL 线程 主从节点建立连接</span></span>
<span class="line"><span style="color:#E2931D;">mysql</span><span style="color:#39ADB5;"> &gt;</span><span style="color:#91B859;"> start</span><span style="color:#91B859;"> slave</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="原理" tabindex="-1">原理 <a class="header-anchor" href="#原理" aria-label="Permalink to &quot;原理&quot;">​</a></h2><p><img src="http://pic.justdoiit.top/imgs/2024-03-01-1709256627.webp" alt="" loading="lazy"></p><ul><li><p><strong>主节点线程</strong></p><ul><li>dump线程：</li></ul></li><li><p><strong>从节点线程</strong></p><ul><li>I/O 线程：向Master请求二进制日志事件，并保存于中继日志中</li><li>SQL 线程：从中继日志中读取日志事件，在本地完成重放</li></ul></li></ul><p><img src="http://pic.justdoiit.top/imgs/2024-03-01-1709257487.webp" alt="" loading="lazy"></p><p>特点</p><ul><li>异步复制</li><li>主从数据不一致比较常见</li></ul><h2 id="主节点配置" tabindex="-1">主节点配置 <a class="header-anchor" href="#主节点配置" aria-label="Permalink to &quot;主节点配置&quot;">​</a></h2><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">1.</span><span style="color:#91B859;"> 修改配置my.cnf</span></span>
<span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">mysqld</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">log_bin</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">mysql-bin</span></span>
<span class="line"><span style="color:#90A4AE;">server-id</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">10</span></span>
<span class="line"><span style="color:#90A4AE;">log-basename</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">master</span><span style="color:#90A4AE;font-style:italic;"> #可选项，设置datadir中日志名称，确保不依赖主机名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">2.</span><span style="color:#91B859;"> 查看从二进制日志的文件和位置开始进行复制</span></span>
<span class="line"><span style="color:#E2931D;">SHOW</span><span style="color:#91B859;"> MASTER</span><span style="color:#91B859;"> STATUS</span><span style="color:#39ADB5;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">3.</span><span style="color:#91B859;"> 创建有复制权限的用户账号</span></span>
<span class="line"><span style="color:#E2931D;">create</span><span style="color:#91B859;"> user</span><span style="color:#91B859;"> repluser@</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;">10.0.0.%</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;"> identified</span><span style="color:#91B859;"> with</span><span style="color:#91B859;"> mysql_native_password</span><span style="color:#91B859;"> by</span><span style="color:#39ADB5;"> &#39;</span><span style="color:#91B859;">123456</span><span style="color:#39ADB5;">&#39;</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">grant</span><span style="color:#91B859;"> replication</span><span style="color:#91B859;"> slave</span><span style="color:#91B859;"> on</span><span style="color:#90A4AE;"> *</span><span style="color:#91B859;">.</span><span style="color:#90A4AE;">*</span><span style="color:#91B859;"> to</span><span style="color:#91B859;"> repluser@</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;">10.0.0.%</span><span style="color:#39ADB5;">&#39;</span><span style="color:#39ADB5;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="从节点配置" tabindex="-1">从节点配置 <a class="header-anchor" href="#从节点配置" aria-label="Permalink to &quot;从节点配置&quot;">​</a></h2><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">1.</span><span style="color:#91B859;"> 启用中继日志</span></span>
<span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">mysqld</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">server_id</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">20</span><span style="color:#90A4AE;font-style:italic;"> #为当前节点设置一个全局惟的ID号</span></span>
<span class="line"><span style="color:#90A4AE;">read_only</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">ON</span><span style="color:#90A4AE;font-style:italic;"> #设置数据库只读，针对supper user无效</span></span>
<span class="line"><span style="color:#90A4AE;">relay_log</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">relay-log</span><span style="color:#90A4AE;font-style:italic;"> #relay log的文件路径，默认值hostname-relay-bin</span></span>
<span class="line"><span style="color:#90A4AE;">relay_log_index</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">relay-log.index</span><span style="color:#90A4AE;font-style:italic;"> #默认值hostname-relay-bin.relay_log_index</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">2.</span><span style="color:#91B859;"> 使用有复制权限的用户账号连接至主服务器，并启动复制线程</span></span>
<span class="line"><span style="color:#E2931D;">change</span><span style="color:#91B859;"> replication</span><span style="color:#91B859;"> source</span><span style="color:#91B859;"> to</span><span style="color:#91B859;"> source_host=</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;">10.0.0.10</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;">,source_user=</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;">repluser</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;">,source_password=</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;">123456</span><span style="color:#39ADB5;">&#39;</span></span>
<span class="line"><span style="color:#90A4AE;">source_log_file</span><span style="color:#39ADB5;">=</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;">mysql-bin.000002</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;">,</span><span style="color:#90A4AE;">source_log_pos</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">2233</span><span style="color:#39ADB5;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">start</span><span style="color:#91B859;"> replica</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">show</span><span style="color:#91B859;"> replica</span><span style="color:#91B859;"> status</span><span style="color:#90A4AE;">\\G</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="范例" tabindex="-1">范例 <a class="header-anchor" href="#范例" aria-label="Permalink to &quot;范例&quot;">​</a></h2><p><img src="http://pic.justdoiit.top/imgs/2024-03-01-1709258137.webp" alt="" loading="lazy"></p><p><img src="http://pic.justdoiit.top/imgs/2024-03-01-1709259242.webp" alt="" loading="lazy"></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">mysql</span><span style="color:#91B859;"> -uroot</span><span style="color:#91B859;"> -p</span><span style="color:#91B859;"> -e</span><span style="color:#39ADB5;"> &quot;</span><span style="color:#91B859;">CHANGE replication source TO</span></span>
<span class="line"><span style="color:#91B859;">  source_HOST=&#39;10.0.0.11&#39;,</span></span>
<span class="line"><span style="color:#91B859;">  source_USER=&#39;zbluo2&#39;,</span></span>
<span class="line"><span style="color:#91B859;">  source_PASSWORD=&#39;luozaibo&#39;,</span></span>
<span class="line"><span style="color:#91B859;">  source_AUTO_POSITION=1;</span></span>
<span class="line"><span style="color:#91B859;">START slave;</span><span style="color:#39ADB5;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">mysql</span><span style="color:#91B859;"> -uroot</span><span style="color:#91B859;"> -p</span><span style="color:#91B859;"> -e</span><span style="color:#39ADB5;"> &quot;</span><span style="color:#91B859;">CHANGE replication source TO</span></span>
<span class="line"><span style="color:#91B859;">  source_HOST=&#39;10.0.0.10&#39;,</span></span>
<span class="line"><span style="color:#91B859;">  source_USER=&#39;zbluo2&#39;,</span></span>
<span class="line"><span style="color:#91B859;">  source_PASSWORD=&#39;luozaibo&#39;,</span></span>
<span class="line"><span style="color:#91B859;">  source_AUTO_POSITION=1;</span></span>
<span class="line"><span style="color:#91B859;">START slave;</span><span style="color:#39ADB5;">&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="关于caching-sha2-password插件" tabindex="-1">关于caching_sha2_password插件 <a class="header-anchor" href="#关于caching-sha2-password插件" aria-label="Permalink to &quot;关于caching_sha2_password插件&quot;">​</a></h2><blockquote><p>从 MySQL 8.0.4 开始，MySQL 默认身份验证插件从 mysql_native_password 改为 caching_sha2_password</p></blockquote><p><strong>在 MySQL 8.0.4 之后创建的所有新用户将默认使用 caching_sha2_password 作为身份验证插件</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div>`,20),o=[e];function r(c,t,i,y,b,u){return n(),a("div",null,o)}const B=s(p,[["render",r]]);export{m as __pageData,B as default};
