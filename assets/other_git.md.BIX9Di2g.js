import{_ as s,c as n,o as a,a4 as l}from"./chunks/framework.GYzjcnJh.js";const d=JSON.parse('{"title":"Git协议","description":"","frontmatter":{"date":"2024-03-05 12:49:57"},"headers":[],"relativePath":"other/git.md","filePath":"other/git.md"}'),p={name:"other/git.md"},e=l(`<h1 id="git协议" tabindex="-1">Git协议 <a class="header-anchor" href="#git协议" aria-label="Permalink to &quot;Git协议&quot;">​</a></h1><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p><code>git</code>专用的一个协议，访问远程库的速度最快，但Git协议缺少用户的鉴权，所以一般只用于下载，默认情况下，通过Git协议不能push代码</p></div><h2 id="git-基本操作" tabindex="-1">git 基本操作 <a class="header-anchor" href="#git-基本操作" aria-label="Permalink to &quot;git 基本操作&quot;">​</a></h2><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#90A4AE;font-style:italic;"># 提交暂存区到本地仓库。</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> commit</span><span style="color:#91B859;"> -m</span><span style="color:#90A4AE;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># add 和 commit</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> commit</span><span style="color:#91B859;"> -a</span><span style="color:#90A4AE;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 移动或重命名工作区文件</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> mv</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 将文件从暂存区和工作区中删除。</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> rm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 日志</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> log</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> shortlog</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="分支管理" tabindex="-1">分支管理 <a class="header-anchor" href="#分支管理" aria-label="Permalink to &quot;分支管理&quot;">​</a></h2><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#90A4AE;font-style:italic;"># 创建分支</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> branch</span><span style="color:#39ADB5;"> &lt;</span><span style="color:#91B859;">branch-nam</span><span style="color:#90A4AE;">e</span><span style="color:#39ADB5;">&gt;</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 切换分支</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> checkout</span><span style="color:#39ADB5;"> &lt;</span><span style="color:#91B859;">branch-nam</span><span style="color:#90A4AE;">e</span><span style="color:#39ADB5;">&gt;</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 创建新分支并切换到该分支</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> checkout</span><span style="color:#91B859;"> -b</span><span style="color:#39ADB5;"> &lt;</span><span style="color:#91B859;">branch-nam</span><span style="color:#90A4AE;">e</span><span style="color:#39ADB5;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 查看分支</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> branch</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> branch</span><span style="color:#91B859;"> -r</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> branch</span><span style="color:#91B859;"> -a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 远程分支不存在时push</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> push</span><span style="color:#91B859;"> --set-upstream</span><span style="color:#91B859;"> origin</span><span style="color:#39ADB5;"> &lt;</span><span style="color:#91B859;">branch-nam</span><span style="color:#90A4AE;">e</span><span style="color:#39ADB5;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="git标签" tabindex="-1">git标签 <a class="header-anchor" href="#git标签" aria-label="Permalink to &quot;git标签&quot;">​</a></h2><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> tag</span><span style="color:#39ADB5;"> &lt;</span><span style="color:#91B859;">tagnam</span><span style="color:#90A4AE;">e</span><span style="color:#39ADB5;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 默认情况下，git push 不会推送标签，你需要显式地推送标签</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> push</span><span style="color:#91B859;"> origin</span><span style="color:#39ADB5;"> &lt;</span><span style="color:#91B859;">tagnam</span><span style="color:#90A4AE;">e</span><span style="color:#39ADB5;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 推送所有标签</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> push</span><span style="color:#91B859;"> origin</span><span style="color:#91B859;"> --tags</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 本地删除</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> tag</span><span style="color:#91B859;"> -d</span><span style="color:#39ADB5;"> &lt;</span><span style="color:#91B859;">tag-nam</span><span style="color:#90A4AE;">e</span><span style="color:#39ADB5;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 远程删除</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> push</span><span style="color:#91B859;"> origin</span><span style="color:#91B859;"> --delete</span><span style="color:#39ADB5;"> &lt;</span><span style="color:#91B859;">tab-nam</span><span style="color:#90A4AE;">e</span><span style="color:#39ADB5;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="自建git服务器" tabindex="-1">自建git服务器 <a class="header-anchor" href="#自建git服务器" aria-label="Permalink to &quot;自建git服务器&quot;">​</a></h2><h3 id="_1-ssh协议实现" tabindex="-1">1 ssh协议实现 <a class="header-anchor" href="#_1-ssh协议实现" aria-label="Permalink to &quot;1 ssh协议实现&quot;">​</a></h3><p>Git 的软件包提供了一个名叫 <code>git-shell</code>的登陆 shell,只允许用户进行 git 操作，而不允许其他操作<br> 用户 git 通过 SSH 连接服务器时，就会直接被拒绝</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#90A4AE;font-style:italic;"># 创建一个git用户</span></span>
<span class="line"><span style="color:#E2931D;">useradd</span><span style="color:#91B859;"> -s</span><span style="color:#91B859;"> /bin/git-shell</span><span style="color:#91B859;"> -m</span><span style="color:#91B859;"> git</span></span>
<span class="line"><span style="color:#E2931D;">passwd</span><span style="color:#39ADB5;"> &lt;</span><span style="color:#91B859;">passwor</span><span style="color:#90A4AE;">d</span><span style="color:#39ADB5;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 存放仓库的目录</span></span>
<span class="line"><span style="color:#E2931D;">mkdir</span><span style="color:#91B859;"> -p</span><span style="color:#91B859;"> /repos</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 创建仓库</span></span>
<span class="line"><span style="color:#6182B8;">cd</span><span style="color:#91B859;"> /repos</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> init</span><span style="color:#91B859;"> --bare</span><span style="color:#91B859;"> hello.git</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 默认情况下，git 仓库的权限为 rwxr-xr-x，只有创建者 root 有写的权限</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 也就意味着使用 git 账号只能 clone, pull，不能 push</span></span>
<span class="line"><span style="color:#E2931D;">chown</span><span style="color:#91B859;"> -R</span><span style="color:#91B859;"> git:git</span><span style="color:#91B859;"> hello.git</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 客户端clone测试</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> clone</span><span style="color:#91B859;"> ssh://git@192.168.2.15/repos/hello.git</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 或scp的写法</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># git clone git@192.168.2.16:/repos/hello.git</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 实现免密码</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 将客户端公钥</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 拷贝到服务器git用户/home/git/.ssh/authorized_keys文件</span></span>
<span class="line"><span style="color:#E2931D;">scp</span><span style="color:#91B859;"> ~/.ssh/id_rsa.pub</span><span style="color:#91B859;"> git@192.168.2.15:/home/git/.ssh/authorized_keys</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_2-git协议实现" tabindex="-1">2 git协议实现 <a class="header-anchor" href="#_2-git协议实现" aria-label="Permalink to &quot;2 git协议实现&quot;">​</a></h3><p>SSH 协议解决了用户直接操作 Git 仓库的权限问题,但是不方便</p><p>使用 Git 协议必须要在服务器上运行 Git 守护进程，git 命令自带了一个 <code>daemon</code> 参数</p><p>这是快速、未经身份验证地访问 Git 数据的常见选择。<br> 由于这不是经过身份验证的服务，因此通过此协议提供的任何内容在其网络内都是公开的</p><p><code>git daemon</code> 会监听 9418 端口，如果你的服务器有防火墙，需要将该端口添加到白名单</p><p><code>git-deamon</code> 文档 <a href="https://git-scm.com/docs/git-daemon" target="_blank" rel="noreferrer">https://git-scm.com/docs/git-daemon</a></p><p><code>提示git: &#39;daemon&#39; is not a git command. See &#39;git --help&#39;</code> 安装<br><code>dnf install -y git-daemon</code></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> daemon</span><span style="color:#91B859;"> --reuseaddr</span><span style="color:#91B859;"> --base-path=/repos/</span><span style="color:#91B859;"> /repos/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 为了让所有的用户都可以访问我们的仓库，还需要在仓库目录下创建一个名为 git-daemon-export-ok 的文件</span></span>
<span class="line"><span style="color:#E2931D;">touch</span><span style="color:#91B859;"> /repos/hello.git/git-daemon-export-ok</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 客户端测试</span></span>
<span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> clone</span><span style="color:#91B859;"> git://192.168.2.15/hello.git</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="设置系统服务" tabindex="-1"><strong>设置系统服务</strong> <a class="header-anchor" href="#设置系统服务" aria-label="Permalink to &quot;**设置系统服务**&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">Unit</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">Description</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">Start</span><span style="color:#E2931D;"> Git</span><span style="color:#91B859;"> Daemon</span></span>
<span class="line"></span>
<span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">Service</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">ExecStart</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">/usr/bin/git</span><span style="color:#E2931D;"> daemon</span><span style="color:#91B859;"> --reuseaddr</span><span style="color:#91B859;"> --base-path=/srv/git/</span><span style="color:#91B859;"> /srv/git/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;">Restart</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">always</span></span>
<span class="line"><span style="color:#90A4AE;">RestartSec</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">500ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;">StandardOutput</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">syslog</span></span>
<span class="line"><span style="color:#90A4AE;">StandardError</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">syslog</span></span>
<span class="line"><span style="color:#90A4AE;">SyslogIdentifier</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">git-daemon</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;">User</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">git</span></span>
<span class="line"><span style="color:#90A4AE;">Group</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">git</span></span>
<span class="line"></span>
<span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">Install</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">WantedBy</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">multi-user.target</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_3-http-s协议实现" tabindex="-1">3 http/s协议实现 <a class="header-anchor" href="#_3-http-s协议实现" aria-label="Permalink to &quot;3 http/s协议实现&quot;">​</a></h3><p><a href="https://git-scm.com/book/zh/v2/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84-Git-Smart-HTTP" target="_blank" rel="noreferrer">https://git-scm.com/book/zh/v2/服务器上的-Git-Smart-HTTP</a></p><p>一般通过 SSH 进行授权访问，通过 git:// 进行无授权访问，但是还有一种协议可以同时实现以上两种方式的访问。 设置 Smart HTTP 一般只需要在服务器上启用一个 Git 自带的名为 git-http-backend 的 CGI 脚本。 该 CGI 脚本将会读取由 git fetch 或 git push 命令向 HTTP URL 发送的请求路径和头部信息， 来判断该客户端是否支持 HTTP 通信（不低于 1.6.6 版本的客户端支持此特性）。 如果 CGI 发现该客户端支持智能（Smart）模式，它将会以智能模式与它进行通信， 否则它将会回落到哑（Dumb）模式下</p><h4 id="_1-首先安装所需的软件" tabindex="-1">1 首先安装所需的软件 <a class="header-anchor" href="#_1-首先安装所需的软件" aria-label="Permalink to &quot;1 首先安装所需的软件&quot;">​</a></h4><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">dnf</span><span style="color:#91B859;"> install</span><span style="color:#91B859;"> -y</span><span style="color:#91B859;"> git-core</span><span style="color:#91B859;"> nginx</span><span style="color:#91B859;"> fcgiwrap</span><span style="color:#91B859;"> httpd-tools</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>其中，<code>Nginx</code> 作为 Web 服务器，本身是不能执行外部 CGI 脚本的，需要通过 fcgiwrap 来中转， 就像使用 php-fpm 来执行 PHP 脚本一样。<code>htpasswd</code> 可以生成 Basic 认证文件。</p><h4 id="_2-启动nginx和fcgiwrap-编写fcgiwrap-nginx配置文件" tabindex="-1">2 启动nginx和fcgiwrap，编写fcgiwrap,nginx配置文件 <a class="header-anchor" href="#_2-启动nginx和fcgiwrap-编写fcgiwrap-nginx配置文件" aria-label="Permalink to &quot;2 启动nginx和fcgiwrap，编写fcgiwrap,nginx配置文件&quot;">​</a></h4><p><code>vim /lib/systemd/system/fcgiwrap.service</code></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">Unit</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">Description</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">Simple</span><span style="color:#E2931D;"> CGI</span><span style="color:#91B859;"> Server</span></span>
<span class="line"><span style="color:#90A4AE;">After</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">nss-user-lookup.target</span></span>
<span class="line"><span style="color:#90A4AE;">Requires</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">fcgiwrap.socket</span></span>
<span class="line"></span>
<span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">Service</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">EnvironmentFile</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">/etc/sysconfig/fcgiwrap</span></span>
<span class="line"><span style="color:#90A4AE;">ExecStart</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">/usr/sbin/fcgiwrap</span><span style="color:#39ADB5;"> \${</span><span style="color:#90A4AE;">DAEMON_OPTS</span><span style="color:#39ADB5;">}</span><span style="color:#91B859;"> -c</span><span style="color:#39ADB5;"> \${</span><span style="color:#90A4AE;">DAEMON_PROCS</span><span style="color:#39ADB5;">}</span></span>
<span class="line"><span style="color:#90A4AE;">User</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">root</span></span>
<span class="line"><span style="color:#90A4AE;">Group</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">root</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>vim /lib/systemd/system/fcgiwrap.socket</code></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">Install</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">Also</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">fcgiwrap.socket</span></span>
<span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">Unit</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">Description</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">fcgiwrap</span><span style="color:#E2931D;"> Socket</span></span>
<span class="line"></span>
<span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">Socket</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">ListenStream</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">/run/fcgiwrap.socket</span></span>
<span class="line"></span>
<span class="line"><span style="color:#39ADB5;">[</span><span style="color:#90A4AE;">Install</span><span style="color:#39ADB5;">]</span></span>
<span class="line"><span style="color:#90A4AE;">WantedBy</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">sockets.target</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>vim /usr/local/nginx/conf/nginx.conf</code></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">location</span><span style="color:#91B859;"> /</span><span style="color:#91B859;"> {</span></span>
<span class="line"><span style="color:#E2931D;">        include</span><span style="color:#91B859;"> fastcgi_params</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> SCRIPT_FILENAME</span><span style="color:#91B859;"> /usr/lib/git-core/git-http-backend</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> GIT_HTTP_EXPORT_ALL</span><span style="color:#39ADB5;"> &quot;&quot;</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> GIT_PROJECT_ROOT</span><span style="color:#91B859;"> /repos</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> PATH_INFO</span><span style="color:#90A4AE;"> $uri</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> REMOTE_USER</span><span style="color:#90A4AE;"> $remote_user</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_pass</span><span style="color:#91B859;"> unix:/var/run/fcgiwrap.socket</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#90A4AE;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>SCRIPT_FILENAME：指定 CGI 脚本 <code>git-http-backend</code> 的位置，表示每次 HTTP 请求会被转发到该 CGI 脚本；</li><li>GIT_HTTP_EXPORT_ALL：<code>git-http-backend</code> 默认只能访问目录下有 <code>git-daemon-export-ok</code>文件的 Git 仓库， 和上面介绍的 Git 协议是一样的，如果指定了 GIT_HTTP_EXPORT_ALL，表示允许访问所有仓库；</li><li>GIT_PROJECT_ROOT：Git 仓库的根目录；</li><li>REMOTE_USER：如果有认证，将认证的用户信息传到 CGI 脚本；</li></ul><p>3 <strong>客户端通过http协议clone</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> clone</span><span style="color:#91B859;"> http://192.168.2.15/hello.git</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="开启身份认证" tabindex="-1"><strong>开启身份认证</strong> <a class="header-anchor" href="#开启身份认证" aria-label="Permalink to &quot;**开启身份认证**&quot;">​</a></h4><p><code>push</code> 代码的时候，会报 403 错误</p><p>默认情况下，只有认证的用户才可以 push 代码</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">location</span><span style="color:#91B859;"> @auth</span><span style="color:#91B859;"> {</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;">        # 使用 Basic 认证</span></span>
<span class="line"><span style="color:#E2931D;">        auth_basic</span><span style="color:#39ADB5;"> &quot;</span><span style="color:#91B859;">user</span><span style="color:#39ADB5;">&quot;</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;">        # 认证的用户文件</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;">        # 使用htpasswd -c /usr/local/nginx/passwd user 生成</span></span>
<span class="line"><span style="color:#E2931D;">        auth_basic_user_file</span><span style="color:#91B859;"> /usr/local/nginx/passwd</span><span style="color:#39ADB5;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;">        # FastCGI 参数</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_pass</span><span style="color:#91B859;">  unix:/run/fcgiwrap.socket</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> SCRIPT_FILENAME</span><span style="color:#91B859;"> /usr/libexec/git-core/git-http-backend</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> GIT_HTTP_EXPORT_ALL</span><span style="color:#39ADB5;"> &quot;&quot;</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;">        # git 库在服务器上的跟目录</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> GIT_PROJECT_ROOT</span><span style="color:#91B859;">    /repos</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> PATH_INFO</span><span style="color:#90A4AE;">           $uri</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;">        # 将认证用户信息传递给 fastcgi 程序</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> REMOTE_USER</span><span style="color:#90A4AE;"> $remote_user</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;">        # 将允许客户端 post 的最大值调整为 100 兆</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;">        # max_client_body_size 100M;</span></span>
<span class="line"><span style="color:#90A4AE;"> </span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;">        # 包涵默认的 fastcgi 参数；</span></span>
<span class="line"><span style="color:#E2931D;">        include</span><span style="color:#91B859;"> fastcgi_params</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#90A4AE;">}</span></span>
<span class="line"><span style="color:#90A4AE;"> </span></span>
<span class="line"><span style="color:#E2931D;">location</span><span style="color:#91B859;"> /</span><span style="color:#91B859;"> {</span></span>
<span class="line"><span style="color:#E2931D;">        error_page</span><span style="color:#F76D47;"> 418</span><span style="color:#91B859;"> =</span><span style="color:#91B859;"> @auth</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#39ADB5;font-style:italic;">        if</span><span style="color:#39ADB5;"> (</span><span style="color:#90A4AE;"> $query_string </span><span style="color:#91B859;">=</span><span style="color:#39ADB5;"> &quot;</span><span style="color:#91B859;">service=git-receive-pack</span><span style="color:#39ADB5;">&quot;</span><span style="color:#39ADB5;"> )</span><span style="color:#39ADB5;"> {</span><span style="color:#39ADB5;font-style:italic;">  return</span><span style="color:#F76D47;"> 418</span><span style="color:#39ADB5;">;</span><span style="color:#39ADB5;"> }</span></span>
<span class="line"><span style="color:#39ADB5;font-style:italic;">        if</span><span style="color:#39ADB5;"> (</span><span style="color:#90A4AE;"> $uri </span><span style="color:#91B859;">~</span><span style="color:#39ADB5;"> &quot;</span><span style="color:#91B859;">git-receive-pack$</span><span style="color:#39ADB5;">&quot;</span><span style="color:#39ADB5;"> )</span><span style="color:#39ADB5;"> {</span><span style="color:#39ADB5;font-style:italic;"> return</span><span style="color:#F76D47;"> 418</span><span style="color:#39ADB5;">;</span><span style="color:#39ADB5;"> }</span></span>
<span class="line"><span style="color:#90A4AE;"> </span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> SCRIPT_FILENAME</span><span style="color:#91B859;"> /usr/libexec/git-core/git-http-backend</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> GIT_HTTP_EXPORT_ALL</span><span style="color:#39ADB5;"> &quot;&quot;</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> GIT_PROJECT_ROOT</span><span style="color:#91B859;"> /repos</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> PATH_INFO</span><span style="color:#90A4AE;"> $uri</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_param</span><span style="color:#91B859;"> REMOTE_USER</span><span style="color:#90A4AE;"> $remote_user</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        fastcgi_pass</span><span style="color:#91B859;"> unix:/run/fcgiwrap.socket</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#E2931D;">        include</span><span style="color:#91B859;"> fastcgi_params</span><span style="color:#39ADB5;">;</span></span>
<span class="line"><span style="color:#90A4AE;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>另外，在 <code>push</code> 的时候，有时候可能会遇到 <code>unpack failed: unable to create temporary object directory</code> 这样的提示错误</p><p>这一般情况下都是由于 Git 仓库目录的权限问题导致的，在这里 Git 仓库的根目录 <code>/repos</code> 是 root 创建的，<br> 而运行 nginx 和 fcgiwrap 的用户都是 www-data，我们可以把 Git 仓库目录设置成对所有人可读可写，<br> 也可以将它的拥有者设置成 www-data 用户</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">chown</span><span style="color:#91B859;"> -R</span><span style="color:#91B859;"> www-data:www-data</span><span style="color:#91B859;"> /repos</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="凭证管理" tabindex="-1">凭证管理 <a class="header-anchor" href="#凭证管理" aria-label="Permalink to &quot;凭证管理&quot;">​</a></h4><p><a href="https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%87%AD%E8%AF%81%E5%AD%98%E5%82%A8" target="_blank" rel="noreferrer">https://git-scm.com/book/zh/v2/Git-工具-凭证存储</a></p><p><img src="http://pic.justdoiit.top/imgs/2024-03-05-1709629505.webp" alt="1" loading="lazy"></p><p>解决了用户身份认证的问题，但是站在用户的角度，每次提交代码都要输入用户名和密码是一件很痛苦的事情</p><p>使用SSH 协议时，我们可以使用 SSH 协议自带的公钥认证机制来省去输入密码的麻烦<br> 在 HTTP 协议中存在类似的方法就是 Git 的凭证存储工具：<code>credential.helper</code></p><p>1 <strong>将用户名和密码信息保存在缓存中</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> config</span><span style="color:#91B859;"> --global</span><span style="color:#91B859;"> credential.helper</span><span style="color:#91B859;"> cache</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这种方式默认只保留 15 分钟，如果要改变保留的时间，可以通过 --timeout 参数设置，或者像下面这样，将密码保存在文件中</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">git</span><span style="color:#91B859;"> config</span><span style="color:#91B859;"> --global</span><span style="color:#91B859;"> credential.helper</span><span style="color:#91B859;"> store</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="综合对比" tabindex="-1">综合对比 <a class="header-anchor" href="#综合对比" aria-label="Permalink to &quot;综合对比&quot;">​</a></h2><ul><li><p>本地协议</p><ul><li>优点：架设简单，不依赖外部服务，直接使用现有文件和网络权限，常用于共享文件系统</li><li>缺点：共享文件系统的配置和使用不方便，且无法保护仓库被意外损坏，传输性能较低</li></ul></li><li><p>SSH 协议</p><ul><li>优点：架设简单，所有数据经过授权加密，数据传输很安全，传输性能很高</li><li>缺点：不支持匿名访问，配置 SSH 的密钥对小白用户有一定的门槛</li></ul></li><li><p>Git 协议</p><ul><li>优点：对开放的项目很适用，无需授权，传输性能最高</li><li>缺点：缺乏授权机制，架设较麻烦，企业一般不会默认开放 9418 端口需要另行添加</li></ul></li><li><p>HTTP/S 协议</p><ul><li>优点：同时支持授权访问和无授权访问，传输性能较高，配合 HTTPS 也可以实现数据安全</li><li>缺点：架设 HTTP 服务较麻烦，认证凭证不好管理</li></ul></li></ul><h2 id="更高级的工具" tabindex="-1">更高级的工具 <a class="header-anchor" href="#更高级的工具" aria-label="Permalink to &quot;更高级的工具&quot;">​</a></h2><p>上面介绍的是搭建 Git 服务器最基本的方法，如果你只是希望能找一个版本控制系统来替代 现有的 SVN，这也许就足够了。但如果你希望你的版本控制系统能拥有一个更友好的 UI 界面， 能更好的管理你的用户和权限，能支持更现代的 Pull Request 功能以及能和 CI/CD 系统更紧密的联系起来， 你就需要一个更高级的工具，你可以试试 GitWeb、Gitolite、Gitlab、Gogs、Gitea， 当然，如果你愿意，你也可以把代码放在那些流行的代码托管平台上，比如 Github、Bitbucket 等等</p><h2 id="http协议实现git服务器脚本" tabindex="-1">http协议实现git服务器脚本 <a class="header-anchor" href="#http协议实现git服务器脚本" aria-label="Permalink to &quot;http协议实现git服务器脚本&quot;">​</a></h2><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">dnf</span><span style="color:#91B859;"> install</span><span style="color:#91B859;"> -y</span><span style="color:#91B859;"> git-core</span><span style="color:#91B859;"> fcgiwrap</span><span style="color:#91B859;"> httpd-tools</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">cat</span><span style="color:#39ADB5;"> &gt;</span><span style="color:#91B859;"> /lib/systemd/system/fcgiwrap.service</span><span style="color:#39ADB5;"> &lt;&lt;</span><span style="color:#39ADB5;"> EOF</span></span>
<span class="line"><span style="color:#91B859;">[Unit]</span></span>
<span class="line"><span style="color:#91B859;">Description=Simple CGI Server</span></span>
<span class="line"><span style="color:#91B859;">After=nss-user-lookup.target</span></span>
<span class="line"><span style="color:#91B859;">Requires=fcgiwrap.socket</span></span>
<span class="line"></span>
<span class="line"><span style="color:#91B859;">[Service]</span></span>
<span class="line"><span style="color:#91B859;">EnvironmentFile=/etc/sysconfig/fcgiwrap</span></span>
<span class="line"><span style="color:#91B859;">ExecStart=/usr/sbin/fcgiwrap </span><span style="color:#90A4AE;">\\$</span><span style="color:#91B859;">{DAEMON_OPTS} -c </span><span style="color:#90A4AE;">\\$</span><span style="color:#91B859;">{DAEMON_PROCS}</span></span>
<span class="line"><span style="color:#91B859;">User=root</span></span>
<span class="line"><span style="color:#91B859;">Group=root</span></span>
<span class="line"><span style="color:#91B859;"> </span></span>
<span class="line"><span style="color:#91B859;">[Install]</span></span>
<span class="line"><span style="color:#91B859;">Also=fcgiwrap.socket</span></span>
<span class="line"><span style="color:#39ADB5;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">cat</span><span style="color:#39ADB5;"> &gt;</span><span style="color:#91B859;"> /lib/systemd/system/fcgiwrap.socket</span><span style="color:#39ADB5;"> &lt;&lt;</span><span style="color:#39ADB5;"> EOF</span></span>
<span class="line"><span style="color:#91B859;">[Unit]</span></span>
<span class="line"><span style="color:#91B859;">Description=fcgiwrap Socket</span></span>
<span class="line"></span>
<span class="line"><span style="color:#91B859;">[Socket]</span></span>
<span class="line"><span style="color:#91B859;">ListenStream=/var/run/fcgiwrap.socket</span></span>
<span class="line"></span>
<span class="line"><span style="color:#91B859;">[Install]</span></span>
<span class="line"><span style="color:#91B859;">WantedBy=sockets.target</span></span>
<span class="line"><span style="color:#39ADB5;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># nginx配置</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># touch /usr/local/nginx/passwd</span></span>
<span class="line"><span style="color:#6182B8;">echo</span><span style="color:#91B859;"> 创建认证密码</span></span>
<span class="line"><span style="color:#E2931D;">htpasswd</span><span style="color:#91B859;"> -c</span><span style="color:#91B859;"> /usr/local/nginx/passwd</span><span style="color:#91B859;"> user</span></span>
<span class="line"></span>
<span class="line"><span style="color:#39ADB5;">[</span><span style="color:#39ADB5;"> !</span><span style="color:#39ADB5;"> -e</span><span style="color:#90A4AE;"> /usr/local/nginx/conf/conf.d </span><span style="color:#39ADB5;">]</span><span style="color:#39ADB5;"> &amp;&amp;</span><span style="color:#E2931D;"> mkdir</span><span style="color:#91B859;"> /usr/local/nginx/conf/conf.d</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">sed</span><span style="color:#91B859;"> -i</span><span style="color:#39ADB5;"> &#39;</span><span style="color:#91B859;">$i\\    include conf.d/*.conf;</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;"> /usr/local/nginx/conf/nginx.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">cat</span><span style="color:#39ADB5;"> &gt;</span><span style="color:#91B859;"> /usr/local/nginx/conf/conf.d/git-server.conf</span><span style="color:#39ADB5;"> &lt;&lt;</span><span style="color:#39ADB5;"> EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#91B859;">server {</span></span>
<span class="line"><span style="color:#91B859;">    listen 80;</span></span>
<span class="line"><span style="color:#91B859;">    server_name 192.168.2.15;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#91B859;">    location @auth {</span></span>
<span class="line"><span style="color:#91B859;">            # 使用 Basic 认证</span></span>
<span class="line"><span style="color:#91B859;">            auth_basic &quot;user&quot;;</span></span>
<span class="line"><span style="color:#91B859;">            # 认证的用户文件</span></span>
<span class="line"><span style="color:#91B859;">            # 使用htpasswd -c /usr/local/nginx/passwd user 生成</span></span>
<span class="line"><span style="color:#91B859;">            auth_basic_user_file /usr/local/nginx/passwd;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#91B859;">            # FastCGI 参数</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_pass  unix:/var/run/fcgiwrap.socket;</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_param SCRIPT_FILENAME /usr/libexec/git-core/git-http-backend;</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_param GIT_HTTP_EXPORT_ALL &quot;&quot;;</span></span>
<span class="line"><span style="color:#91B859;">            # git 库在服务器上的跟目录</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_param GIT_PROJECT_ROOT    /;</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_param PATH_INFO           </span><span style="color:#90A4AE;">\\$</span><span style="color:#91B859;">uri;</span></span>
<span class="line"><span style="color:#91B859;">            # 将认证用户信息传递给 fastcgi 程序</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_param REMOTE_USER </span><span style="color:#90A4AE;">\\$</span><span style="color:#91B859;">remote_user;</span></span>
<span class="line"><span style="color:#91B859;">            # 将允许客户端 post 的最大值调整为 100 兆</span></span>
<span class="line"><span style="color:#91B859;">            # max_client_body_size 100M;</span></span>
<span class="line"><span style="color:#91B859;">    </span></span>
<span class="line"><span style="color:#91B859;">            # 包涵默认的 fastcgi 参数；</span></span>
<span class="line"><span style="color:#91B859;">            include fastcgi_params;</span></span>
<span class="line"><span style="color:#91B859;">    }</span></span>
<span class="line"><span style="color:#91B859;">    </span></span>
<span class="line"><span style="color:#91B859;">    location /repos {</span></span>
<span class="line"><span style="color:#91B859;">            error_page 418 = @auth;</span></span>
<span class="line"><span style="color:#91B859;">            if ( </span><span style="color:#90A4AE;">\\$</span><span style="color:#91B859;">query_string = &quot;service=git-receive-pack&quot; ) {  return 418; }</span></span>
<span class="line"><span style="color:#91B859;">            if ( </span><span style="color:#90A4AE;">\\$</span><span style="color:#91B859;">uri ~ &quot;git-receive-pack$&quot; ) { return 418; }</span></span>
<span class="line"><span style="color:#91B859;">    </span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_param SCRIPT_FILENAME /usr/libexec/git-core/git-http-backend;</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_param GIT_HTTP_EXPORT_ALL &quot;&quot;;</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_param GIT_PROJECT_ROOT /;</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_param PATH_INFO </span><span style="color:#90A4AE;">\\$</span><span style="color:#91B859;">uri;</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_param REMOTE_USER </span><span style="color:#90A4AE;">\\$</span><span style="color:#91B859;">remote_user;</span></span>
<span class="line"><span style="color:#91B859;">            fastcgi_pass unix:/var/run/fcgiwrap.socket;</span></span>
<span class="line"><span style="color:#91B859;">            include fastcgi_params;</span></span>
<span class="line"><span style="color:#91B859;">    }</span></span>
<span class="line"><span style="color:#91B859;">}</span></span>
<span class="line"><span style="color:#39ADB5;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6182B8;">echo</span><span style="color:#91B859;"> done</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div>`,60),o=[e];function r(c,t,i,b,y,u){return a(),n("div",null,o)}const B=s(p,[["render",r]]);export{d as __pageData,B as default};
