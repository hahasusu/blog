import{_ as s,c as n,o as a,a4 as l}from"./chunks/framework.GYzjcnJh.js";const d=JSON.parse('{"title":"","description":"","frontmatter":{"date":"2024-02-22 03:00:52"},"headers":[],"relativePath":"devops/zabbix/proxy.md","filePath":"devops/zabbix/proxy.md"}'),p={name:"devops/zabbix/proxy.md"},e=l(`<h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><blockquote><p>zabbix作为一个分布式监控系统 ，支持通过代理(proxy)收集zabbix-agent的监控数据，然后再由 zabbix-proxy把数据发给server[]</p></blockquote><ul><li>可以减轻zabbix-server 的压力</li></ul><h2 id="安装zabbix-proxy" tabindex="-1">安装zabbix-proxy <a class="header-anchor" href="#安装zabbix-proxy" aria-label="Permalink to &quot;安装zabbix-proxy&quot;">​</a></h2><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#E2931D;">rpm</span><span style="color:#91B859;"> -Uvh</span><span style="color:#91B859;"> https://repo.zabbix.com/zabbix/6.0/rhel/8/x86_64/zabbix-release-6.0-4.el8.noarch.rpm</span></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># sed -i &#39;s/repo.zabbix.com/mirrors.aliyun.com\\/zabbix/&#39; /etc/yum.repos.d/zabbix.repo</span></span>
<span class="line"><span style="color:#E2931D;">sed</span><span style="color:#91B859;"> -i</span><span style="color:#39ADB5;"> &#39;</span><span style="color:#91B859;">s/repo.zabbix.com/mirrors.cloud.tencent.com\\/zabbix/</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;"> /etc/yum.repos.d/zabbix.repo</span></span>
<span class="line"><span style="color:#E2931D;">sed</span><span style="color:#91B859;"> -ri</span><span style="color:#39ADB5;"> &#39;</span><span style="color:#91B859;">s/(gpgcheck=)1/\\10/</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;"> /etc/yum.repos.d/zabbix.repo</span></span>
<span class="line"><span style="color:#E2931D;">dnf</span><span style="color:#91B859;"> clean</span><span style="color:#91B859;"> all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">dnf</span><span style="color:#91B859;"> install</span><span style="color:#91B859;"> -y</span><span style="color:#91B859;"> zabbix-proxy-mysql</span><span style="color:#91B859;"> zabbix-sql-scripts</span><span style="color:#91B859;"> zabbix-selinux-policy</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 安装mysql,确保数据库服务器已启动并正在运行。</span></span>
<span class="line"><span style="color:#E2931D;">dnf</span><span style="color:#91B859;"> install</span><span style="color:#91B859;"> -y</span><span style="color:#91B859;"> mysql-server</span></span>
<span class="line"><span style="color:#E2931D;">systemctl</span><span style="color:#91B859;"> enable</span><span style="color:#91B859;"> --now</span><span style="color:#91B859;"> mysqld</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 创建初始数据库</span></span>
<span class="line"><span style="color:#E2931D;">dnf</span><span style="color:#91B859;"> install</span><span style="color:#91B859;"> -y</span><span style="color:#91B859;"> mysql-server</span></span>
<span class="line"><span style="color:#E2931D;">systemctl</span><span style="color:#91B859;"> enable</span><span style="color:#91B859;"> --now</span><span style="color:#91B859;"> mysqld</span></span>
<span class="line"><span style="color:#E2931D;">cat</span><span style="color:#39ADB5;"> &lt;&lt;</span><span style="color:#39ADB5;"> EOF</span><span style="color:#39ADB5;"> |</span><span style="color:#E2931D;"> mysql</span></span>
<span class="line"><span style="color:#91B859;">create database zabbix_proxy character set utf8mb4 collate utf8mb4_bin;</span></span>
<span class="line"><span style="color:#91B859;">create user zabbix@localhost identified by &#39;luozaibo&#39;;</span></span>
<span class="line"><span style="color:#91B859;">grant all privileges on zabbix_proxy.* to zabbix@localhost;</span></span>
<span class="line"><span style="color:#91B859;">set global log_bin_trust_function_creators = 1;</span></span>
<span class="line"><span style="color:#91B859;">quit;</span></span>
<span class="line"><span style="color:#39ADB5;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 在 Zabbix 服务器主机上导入初始架构和数据。系统将提示您输入新创建的密码。</span></span>
<span class="line"><span style="color:#E2931D;">cat</span><span style="color:#91B859;"> /usr/share/zabbix-sql-scripts/mysql/proxy.sql</span><span style="color:#39ADB5;"> |</span><span style="color:#E2931D;"> mysql</span><span style="color:#91B859;"> --default-character-set=utf8mb4</span><span style="color:#91B859;"> -uzabbix</span><span style="color:#91B859;"> -p</span><span style="color:#91B859;"> zabbix_proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">cat</span><span style="color:#39ADB5;"> &lt;&lt;</span><span style="color:#39ADB5;"> EOF</span><span style="color:#39ADB5;"> |</span><span style="color:#E2931D;"> mysql</span></span>
<span class="line"><span style="color:#91B859;">set global log_bin_trust_function_creators = 0;</span></span>
<span class="line"><span style="color:#91B859;">quit;</span></span>
<span class="line"><span style="color:#39ADB5;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">systemctl</span><span style="color:#91B859;"> enable</span><span style="color:#91B859;"> --now</span><span style="color:#91B859;"> zabbix-proxy</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h2 id="主动模式配置" tabindex="-1">主动模式配置 <a class="header-anchor" href="#主动模式配置" aria-label="Permalink to &quot;主动模式配置&quot;">​</a></h2><p><strong>vim /etc/zabbix/zabbix_proxy.conf</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#90A4AE;font-style:italic;"># 主动模式为0</span></span>
<span class="line"><span style="color:#90A4AE;">ProxyMode</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 指向zabbix-server</span></span>
<span class="line"><span style="color:#90A4AE;">Server</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">server</span><span style="color:#E2931D;"> ip</span></span>
<span class="line"><span style="color:#90A4AE;">Hostname</span><span style="color:#39ADB5;">=</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;">DBHost</span><span style="color:#39ADB5;">=</span></span>
<span class="line"><span style="color:#90A4AE;">DBName</span><span style="color:#39ADB5;">=</span></span>
<span class="line"><span style="color:#90A4AE;">DBUser</span><span style="color:#39ADB5;">=</span></span>
<span class="line"><span style="color:#90A4AE;">DBPassword</span><span style="color:#39ADB5;">=</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># 开启远程命令，允许server到Proxy上执行命令，故障自愈时使用</span></span>
<span class="line"><span style="color:#90A4AE;">EnableRemoteCommands</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#90A4AE;font-style:italic;"># proxy将数据发送给server后 数据在本地保留的时间 ，默认不保留</span></span>
<span class="line"><span style="color:#90A4AE;">ProxyLocalBuffer</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">360</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>vim /etc/zabbix/zabbix_agent2.conf</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#90A4AE;">ServerActive</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">server-proxy</span><span style="color:#E2931D;"> ip</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>web界面添加zabbix-proxy</strong></p><h2 id="修改配置脚本" tabindex="-1">修改配置脚本 <a class="header-anchor" href="#修改配置脚本" aria-label="Permalink to &quot;修改配置脚本&quot;">​</a></h2><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-lighter vp-code" tabindex="0"><code><span class="line"><span style="color:#90A4AE;">Server</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">192.168.2.15</span></span>
<span class="line"><span style="color:#90A4AE;">DBPassword</span><span style="color:#39ADB5;">=</span><span style="color:#91B859;">luozaibo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E2931D;">sed</span><span style="color:#91B859;"> -ri</span><span style="color:#39ADB5;"> &quot;</span><span style="color:#91B859;">s/(^Server=).*/\\1</span><span style="color:#90A4AE;">$Server</span><span style="color:#91B859;">/</span><span style="color:#39ADB5;">&quot;</span><span style="color:#91B859;"> /etc/zabbix/zabbix_proxy.conf</span></span>
<span class="line"><span style="color:#E2931D;">sed</span><span style="color:#91B859;"> -ri</span><span style="color:#39ADB5;"> &#39;</span><span style="color:#91B859;">s/^# (DBPassword=)/\\1$DBPassword/</span><span style="color:#39ADB5;">&#39;</span><span style="color:#91B859;"> /etc/zabbix/zabbix_proxy.conf</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div>`,13),o=[e];function r(c,t,i,b,y,m){return a(),n("div",null,o)}const B=s(p,[["render",r]]);export{d as __pageData,B as default};
